<!DOCTYPE html>
<html lang="en">
<head>
    <title>Projects</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    
    <style>
        #project-table tbody tr.selected {
            background-color: #d0ebff;
        }
    </style>

</head>

<body class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Projects</h2>
        <button class="btn btn-primary" data-bs-toggle="offcanvas" data-bs-target="#addProjectCanvas">Add Project</button>
      </div>      
    <table id="project-table" class="display">
        <thead><tr><th>ID</th><th>Title</th><th>Status</th></tr></thead>
        <tbody>
        {% for project in projects %}
            <tr><td>{{ project.id }}</td><td>{{ project.title }}</td><td>{{ project.status }} </td></tr>
        {% endfor %}
        </tbody>
    </table>

    <div id="measures" class="mt-4">
        <h3 id="measures-title">Measures</h3>
        <button id="add-measure-btn" class="btn btn-success mb-3 d-none" data-bs-toggle="offcanvas" data-bs-target="#addMeasureCanvas">
            Add Measure
          </button>
        <div id="measures-placeholder" class="text-muted">Select a project to view measures.</div>
    
        <table id="measures-table" class="table table-bordered d-none">
            <thead><tr><th>ID</th><th>Type</th><th>Install Date</th></tr></thead>
            <tbody id="measures-body"></tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function() {
            const table = $('#project-table').DataTable();
        
            $('#project-table tbody').on('click', 'tr', function () {
                const isSelected = $(this).hasClass('selected');
                $('#project-table tbody tr').removeClass('selected');

                if (isSelected) {
                    // Deselect and show placeholder
                    $('#measures-title').text('Measures');
                    $('#measures-table').addClass('d-none');
                    $('#measures-placeholder').removeClass('d-none');
                    $('#add-measure-btn').addClass('d-none');
                    $('#measure-project-id').val('');
                } else {
                    $(this).addClass('selected');
                    const data = table.row(this).data();
                    const projectId = data[0];
                    const projectTitle = data[1];

                    $('#measures-title').text(`Measures for Project: ${projectTitle}`);
                    $('#measures-placeholder').addClass('d-none');
                    $('#measures-table').removeClass('d-none');
                    $('#add-measure-btn').removeClass('d-none');
                    $('#measure-project-id').val(projectId); // Store selected project ID

                    fetch(`/measures/${projectId}`)
                        .then(response => response.json())
                        .then(measures => {
                            const tbody = $('#measures-body');
                            tbody.empty();
                            if (measures.length === 0) {
                                tbody.append('<tr><td colspan="3">No measures found.</td></tr>');
                            } else {
                                for (let m of measures) {
                                    tbody.append(
                                        `<tr>
                                            <td>${m.id}</td>
                                            <td>${m.measure_type}</td>
                                            <td>${m.install_date}</td>
                                        </tr>`
                                    );
                                }
                            }
                        });
                }
            });
 
    });
    </script>

<script>
$(document).ready(function() {

    $('#add-project-form').on('submit', function(e) {
      e.preventDefault();
  
      const title = $('#project-title').val();
      const status = $('#project-status').val();
  
      fetch('/add_project', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ title, status })
      })
      .then(res => {
        if (res.ok) {
          // Close panel, refresh page or re-fetch data
          const canvas = bootstrap.Offcanvas.getInstance(document.getElementById('addProjectCanvas'));
          canvas.hide();
          location.reload(); // or use DataTables API to add row dynamically
        } else {
          alert('Failed to add project');
        }
      });
    });
});
  </script>

<!-- jscript for add measure -->
<script>
    $(document).ready(function() {
        $('#add-measure-form').on('submit', function(e) {
            e.preventDefault();
    
            const projectId = $('#measure-project-id').val();
            const measureType = $('#measure-type').val();
            const installDate = $('#install-date').val();
    
            fetch('/add_measure', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    project_id: projectId,
                    measure_type: measureType,
                    install_date: installDate
                })
            })
            .then(res => {
                if (res.ok) {
                    const canvas = bootstrap.Offcanvas.getInstance(document.getElementById('addMeasureCanvas'));
                    canvas.hide();
                    location.reload(); // Or just re-fetch measures if you prefer
                } else {
                    alert('Failed to add measure');
                }
            });
        });
    });
    </script>

    <!---Add project sidebar element-->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="addProjectCanvas" aria-labelledby="addProjectLabel">
        <div class="offcanvas-header">
          <h5 id="addProjectLabel">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <form id="add-project-form">
            <div class="mb-3">
              <label for="project-title" class="form-label">Title</label>
              <input type="text" class="form-control" id="project-title" required>
            </div>

            <div class="mb-3">
              <label for="project-status" class="form-label">Status</label>
              <select class="form-select" id="project-status" required>
                <option value="" disabled selected>Select status</option>
                <option value="Not Started">Not Started</option>
                <option value="In Progress">In Progress</option>
                <option value="Complete">Complete</option>
              </select>
            </div>
            <button type="submit" class="btn btn-success">Add Project</button>

          </form>
        </div>
      </div>

      <!-- Add measure sidebar eleement-->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="addMeasureCanvas" aria-labelledby="addMeasureLabel">
        <div class="offcanvas-header">
          <h5 id="addMeasureLabel">Add New Measure</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
          <form id="add-measure-form">
            <!-- Hidden field for project ID -->
            <input type="hidden" id="measure-project-id">
      
            <div class="mb-3">
              <label for="measure-type" class="form-label">Measure Type</label>
              <input type="text" class="form-control" id="measure-type" required>
            </div>
      
            <div class="mb-3">
              <label for="install-date" class="form-label">Install Date</label>
              <input type="date" class="form-control" id="install-date" required>
            </div>
      
            <button type="submit" class="btn btn-success">Add Measure</button>
          </form>
        </div>
      </div>
      
</body>
</html>